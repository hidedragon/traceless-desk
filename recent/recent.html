<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>.</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-size: 10pt;
        }
    </style>
</head>
<body>
<div style="height:100%;width:100%;display:flex;flex-direction: row;align-items: center">
    <div style="height:100%;width:200px;background-color: #ffffff;border-right: 1px solid #d0d0d0;display: flex;flex-direction: column;align-items: center;overflow: hidden">
        <div style="width:100%;height:32px;background-color: #f0f0f0;border-bottom: 1px solid #d0d0d0;line-height: 32px;text-align: center;font-size: 11pt;font-weight: bold" >最近
        </div>
        <div style="width:100%;height:32px;line-height: 32px;cursor: pointer;padding-left: 10px;border-bottom: 1px solid #f0f0f0" onclick="addGroup()">
            <img src="../images/groupChat.png" width="16" height="16" style="float: left;margin-top: 8px;margin-right: 8px;cursor: pointer" >
            创建群聊</div>
        <div id="recent" style="width:200px;display: flex;flex-direction: column;align-items: center;">
        </div>
    </div>
    <div style="flex:1;height:100%;background-color: white;display: flex">
        <iframe id="frame" style="width:100%;height:100%" frameborder="0"></iframe>
    </div>
</div>
</body>
<script>
    var selected = "";
    function hover(name){
        if(selected!=name)
            event.target.style.backgroundColor = "#f0f0f0";

    }
    function leave(name){
        if(selected!=name)
            event.target.style.backgroundColor = "#ffffff";

    }
    function select(name,isGroupChat,id){

        if(selected){
            document.getElementById("recent"+selected).style.backgroundColor = "#ffffff";
        }
        selected = name;
        document.getElementById("recent"+name).style.backgroundColor = "#f0f0f0";

    }
    function chat(name,isGroupChat,id) {
        select(name)
        showChatBox(isGroupChat,id);
    }
    function showChatBox(isGroupChat,id) {
        document.getElementById("frame").src="chat.html?"+isGroupChat+"&"+id;
    }
    function addGroup() {
        selected="";
        refreshRecentList();
        document.getElementById("frame").src="addGroup.html";
    }
    function refreshRecentList() {
        var all = window.top.Store.getAllRecent();
        var groups = window.top.Store.getGroups();
        var html="";
        var i=0;
        if(all){
            for(;i<all.length;i++){
                var re = all[i];
                html+="<div id=\"recent";
                html+=i;
                html+="\" style=\"width:100%;height:50px;cursor: pointer;padding-left: 10px;display:flex;flex-direction:row;justify-content: flex-start;align-items: center\" onmouseover=\"hover('";
                html+=i;
                html+="')\" onmouseout=\"leave('";
                html+=i;
                html+="')\" onclick=\"chat('";
                html+=i;
                html+="',false,'";
                html+=re.id;
                html+="')\">";
                html+=re.id&&window.top.Store.getFriend(re.id)?window.top.Store.getFriend(re.id).name:"error";
                if(re.newReceive){
                    html+="<div style='color:white;font-size: 9pt;border:1px solid red;width:15px;height:15px;text-align: center;line-height: 15px;border-radius: 15px;background-color: red;margin-left: 5px;margin-bottom: 15px'>"+re.newMsgNum+"</div>";
                }
                html+="</div>";
            }

        }
        if(groups){
            for(var j=0;j<groups.length;j++,i++){
                var g = groups[j];
                html+="<div id=\"recent";
                html+=i;
                html+="\" style=\"width:100%;height:50px;line-height: 50px;cursor: pointer;padding-left: 10px\" onmouseover=\"hover('";
                html+=i;
                html+="')\" onmouseout=\"leave('";
                html+=i;
                html+="')\" onclick=\"chat('";
                html+=i;
                html+="',true,'";
                html+=g.id;
                html+="')\">";
                html+="<img src=\"../images/mulChat.png\" width=\"16\" height=\"16\"/>";
                html+=g.name;
                if(g.newReceive){
                    html+="<span style='color:red;font-style: italic;font-size: 9pt;padding-left: 10px'>"+g.newMsgNum+"</span>";
                }
                html+="</div>";
            }
        }
        document.getElementById("recent").innerHTML=html;
        if(selected){
            select(selected);
        }

    }

    refreshRecentList();
    window.top.Store.on("receiveMessage",refreshRecentList);
    window.top.Store.on("readChatRecords",refreshRecentList);
    window.top.Store.on("readGroupChatRecords",refreshRecentList);
    window.top.Store.on("addGroup",refreshRecentList);
    window.top.Store.on("receiveGroupMessage",refreshRecentList);

    window.addEventListener("beforeunload", function (event) {
        window.top.Store.un("receiveMessage",refreshRecentList);
        window.top.Store.un("readChatRecords",refreshRecentList);
        window.top.Store.un("readGroupChatRecords",refreshRecentList);
        window.top.Store.un("addGroup",refreshRecentList);
        window.top.Store.un("receiveGroupMessage",refreshRecentList);
    });
</script>
</html>